package gocipher

import "math"

/*
 * N-gram frequencies for English text
 * Data from: http://norvig.com/mayzner.html
 */

// Unigram model frequencies for English letters A-Z
var unigramFreqs = []float64{0.080406052, 0.014846488, 0.033437737, 0.038169583, 0.124920625,
	0.024031234, 0.018693758, 0.050533014, 0.075692775, 0.001587737, 0.005405135, 0.04068986,
	0.025117606, 0.072336292, 0.076406929, 0.02135891, 0.001204689, 0.062794207, 0.065127666,
	0.092755648, 0.027297018, 0.010532516, 0.016756642, 0.002348569, 0.016649801, 0.000899507}

// Bigram model frequencies for English letters AA-AZ, BA-BZ ... ZA-ZZ
var bigramFreqs = []float64{
	0.0000282994070884686, 0.00229786417208144, 0.0044777219955134, 0.00367956418220926, 0.000123965197228568, 0.000742072946387665, 0.00204724906481006,
	0.000136432949155519, 0.00316447751815382, 0.000117526303314498, 0.00104699320319186, 0.0108744952887545, 0.00284865969005309, 0.0198515107938655,
	0.0000462616737123756, 0.00202845908185282, 0.0000224438116339269, 0.0107489847429423, 0.00871095072593466, 0.0148673230099991, 0.00119032774306843,
	0.00204932647062068, 0.000599162639145033, 0.000188393785790391, 0.00217360835003636, 0.000118691292239892, 0.0014620446497567, 0.000109331046227314,
	0.0000188952008556964, 0.0000247409596732281, 0.0057628371616522, 0.00000145715860745092, 0.0000025546511654583, 0.0000105679067062529,
	0.00106597118557569, 0.000232245155736575, 0.000000936101631743801, 0.0023340017134195, 0.0000312905207187921, 0.0000209465191502648,
	0.00195410530775138, 0.00000547131014969157, 0.000000122889160072536, 0.00111559851840631, 0.000458324041287304, 0.000171039221607454,
	0.00184944193871616, 0.0000384390171997421, 0.0000029506609216681, 0.000000276140106070307, 0.00176468429525041, 0.000000357267535739383,
	0.00538164098285948, 0.00000629576510020678, 0.000831382851473972, 0.0000223097275184226, 0.0065141736322052, 0.000014081226385831,
	0.00000885768060932945, 0.00597765977699385, 0.00281484803281398, 0.00000105049722317805, 0.00117626124255662, 0.00149011351155187,
	0.0000266503046112233, 0.00000860019166926555, 0.00793859724517974, 0.0000131460479141008, 0.0000547453911729039, 0.00149455830642356,
	0.000228229669992271, 0.00460971756983327, 0.00162613976953232, 0.00000208159886511016, 0.00000138641504333616, 0.000000310936464723135,
	0.000417186145749976, 0.00000730644125052819, 0.00151067363947176, 0.0000277303518211444, 0.0000251909822699103, 0.000427514542261355,
	0.00764818390572569, 0.0000277861205453, 0.000310032877262304, 0.0000543839596641643, 0.00492966404507964, 0.0000478187439101255,
	0.00000336707879152447, 0.000323402665046145, 0.000181767369811771, 0.0000756940332720128, 0.00188234971058648, 0.0000173267658240488,
	0.00000706747615628441, 0.000854499049877935, 0.00126260674961793, 0.0000289567711404811, 0.00148460771004453, 0.00019052697025543,
	0.0000816240791168168, 0.000000459727657677923, 0.000504227393082564, 0.000000780484800056189, 0.00688165289873496, 0.0002707357514432,
	0.00477282718632627, 0.0116812336513087, 0.00377605408470572, 0.00162732115048839, 0.00119536133847588, 0.000263237165944311, 0.00183351654220557,
	0.0000454645078400032, 0.000164718022260788, 0.00530301558920022, 0.00373663638276904, 0.0145424845647879, 0.000725004577413644, 0.00171573738951278,
	0.000572519573342506, 0.0204826481270149, 0.0133939375075806, 0.00412608241843902, 0.000311527347422729, 0.0025478371547114, 0.00116805779938437,
	0.00214044590303755, 0.00143745726447239, 0.0000452324283207359, 0.00163999785363759, 0.00000274176112400213, 0.00000576465727748271,
	0.00000495336950400344, 0.00236573195443946, 0.0014631657862762, 0.00000511569103797953, 0.0000018321924516347, 0.00284585627191231,
	0.000000732511688754533, 0.00000116794388860267, 0.000649048818170187, 0.0000068592512620014, 0.00000419307789828215, 0.00487753568451577,
	0.00000222115030092548, 0.0000000529956975914963, 0.00213188614847224, 0.0000550952209399898, 0.000816643643941075, 0.000959749104657083,
	0.000000286309761617628, 0.00000228804340469927, 0.000000288018831193305, 0.0000909807381757351, 0.0000000935785636518251, 0.00148077067045702,
	0.00000494557424580187, 0.00000228930419373051, 0.0000315951702616709, 0.00385189513023461, 0.0000120448925068347, 0.000247547306103897,
	0.00227503360498919, 0.00151636561501014, 0.000000387644926367115, 0.00000260275585277419, 0.000606367626067629, 0.0000985814936909568,
	0.000656391013340657, 0.00132127808178708, 0.00000411855764151095, 0.00000012257635671795, 0.00196777866090593, 0.000511931727293172,
	0.000154026396508011, 0.000857695086944006, 0.000000422875379471205, 0.0000064762650486341, 0.000000197551987080179, 0.000259399815681354,
	0.0000012168809449358, 0.00925763559181987, 0.0000438982744900169, 0.0000122821602350297, 0.0000285652292943179, 0.030747412428376,
	0.0000224317328848901, 0.00000276265227412142, 0.00000522417954021426, 0.0076324181389379, 0.000000454795507732096, 0.00000233914845072241,
	0.000125919174807573, 0.000127432414942534, 0.000257579772554569, 0.00484902068569483, 0.0000059213210428469, 0.00000422935422110583,
	0.000843925355600317, 0.000146841708820797, 0.00130185876224212, 0.000736927617054512, 0.00000223182639999927, 0.0000477415864586325,
	0.0000000936271510209614, 0.000500890899862585, 0.00000380541311138459, 0.00286282434627152, 0.000986028683031316, 0.0069870748758413,
	0.00295503910964045, 0.00384646387735622, 0.00203256515537768, 0.00254961379832333, 0.0000209125512594535, 0.000227822992293991,
	0.0000111092944813987, 0.000429127437218329, 0.00431534617561455, 0.00317759946495957, 0.0243274528989249, 0.00834931850773829, 0.000892112065133701,
	0.000113037593618119, 0.00315172397532161, 0.0112842988256371, 0.0112327373629905, 0.000174089939526876, 0.00287848218916358, 0.00000624612583226131,
	0.000220319919379177, 0.00000221572163771841, 0.000643397536504039, 0.000258614909785358, 0.000000754031637453953, 0.0000012226890861354,
	0.00000092746797543538, 0.000518874875110231, 0.000000858891337053633, 0.000000367029695760152, 0.000001256132091499, 0.0000276273746161095,
	0.00000105684620918008, 0.000000617142222023578, 0.00000113216620695422, 0.00000129786438575911, 0.00000147212209853558, 0.000537896690748721,
	0.00000217382265686344, 0, 0.00000242815483654281, 0.00000118065108156729, 0.00000103482229952049, 0.000587024288656338, 0.000000609904831936248,
	0.000000413494116052278, 0.0000000573650142904673, 0.000000397288987162174, 0.0000000782629028040116, 0.000169557656890647, 0.00000901036943138502,
	0.00000224353843852742, 0.00000670106993931945, 0.00213767969714709, 0.0000158740992430029, 0.000025629904957985, 0.0000318518637165598,
	0.000978784303101225, 0.00000123105568923973, 0.00000453340156432916, 0.000105698197363832, 0.0000178919333925374, 0.00051438830893253,
	0.0000607607968682768, 0.00000726777598961326, 0.0000000664058114731109, 0.0000272172234529148, 0.00047508897008289, 0.0000103317954993043,
	0.0000302567524459948, 0.00000156577584848125, 0.0000217815182691872, 0.000000196981706134405, 0.0000594970869204542, 0.0000000534673851896807,
	0.00527529444167098, 0.0000669029567248087, 0.000118219114157536, 0.00252606378528879, 0.00829254234930935, 0.000534768851552343,
	0.0000608786925235505, 0.0000161874054945915, 0.00624352184328239, 0.0000011241886574553, 0.000197145201567591, 0.00576571076300642,
	0.000230209193887872, 0.0000586983573859611, 0.00386884199993103, 0.000190304866042234, 0.00000127069447079904, 0.000100512684857795,
	0.00141513491345895, 0.00123637099314948, 0.00135189357712251, 0.000349059128853126, 0.000126388913591207, 0.00000305442971070236,
	0.00425013516017651, 0.00000417347413611882, 0.00565269345479224, 0.000902555221819108, 0.0000431226640315768, 0.00000671322068277915,
	0.00793006485913469, 0.0000381834469287806, 0.0000122486356596303, 0.00000533180694659306, 0.00317691369396527, 0.0000010367640210243,
	0.00000140331777335831, 0.0000460653782584987, 0.000960690120706156, 0.0000879007000842792, 0.00336877622531187, 0.00239175226032707,
	0.000000251244221846739, 0.0000310605584739317, 0.000928331655642838, 0.0000136678429213055, 0.00114618532556016, 0.00000289840857535916,
	0.00000583947721547231, 0.0000003526428693632, 0.000621864133359196, 0.000000344112771534981, 0.00347234972858743, 0.0000433593809847042,
	0.0041574584312937, 0.0135228144586996, 0.00691722265020522, 0.000671807282670597, 0.0095301484213241, 0.000108837112352459, 0.00339212477596274,
	0.000110863959990947, 0.000516054648576944, 0.000637839069480425, 0.000277494857044365, 0.000727646948995576, 0.00464574957798696,
	0.000060357061365722, 0.0000595001291281363, 0.000091517473621623, 0.00508937451866401, 0.0104125115124106, 0.00078644454874289, 0.000520071483064057,
	0.0000579700511645294, 0.000026208656774649, 0.000979174450454429, 0.0000436906610163499, 0.00057486066316008, 0.000966708176718387,
	0.00166405085836748, 0.00195449429219959, 0.00038630665183098, 0.0117497528104781, 0.00094024210335275, 0.000213543714925252, 0.000877507467665713,
	0.0000697589276024244, 0.000643118049543935, 0.00365492648417223, 0.00546256885072672, 0.0175804642276026, 0.00210259217105969, 0.00223911051694962,
	0.0000103656569944166, 0.0127653906160459, 0.00289966767659996, 0.00442103298154556, 0.00870002319360933, 0.00178086544999769, 0.00330478041827838,
	0.000185754126944127, 0.000361812839081237, 0.000034722234897361, 0.00323572470985556, 0.0000130872011623778, 0.0000117590888340912,
	0.0000119866727804302, 0.00477989185044424, 0.00001454864113275, 0.00000473636483665227, 0.000943900197432999, 0.00123094104751958,
	0.0000009968471920387, 0.00000819227800761735, 0.00262987083421635, 0.000159561635577307, 0.0000118936662709858, 0.00361373182014583,
	0.00136545598403418, 0.000000381268632135719, 0.00474470915872401, 0.000545711864451855, 0.00105782133604485, 0.00104540205090525,
	0.00000220668084053576, 0.0000120714644779673, 0.000000522568858587612, 0.000117637523703627, 0.00000226346209709193, 0.00000152439997981224,
	0.000000384245583789223, 0.000000399834681583051, 0.000000184391193786177, 0.000000203018243434176, 0.000000336167495398046, 0,
	0.0000000934540806841839, 0.00000317577577848941, 0.0000000840270671147563, 0, 0.00000237933375152141, 0.000000351058992059823,
	0.000000659585948856594, 0.000000469688423003191, 0.0000000965292710329483, 0.000000607242456898978, 0.000000618628924588682, 0.000001577707062149,
	0.000000491372575731152, 0.00147541325690293, 0.000000225386520505669, 0.0000000579118881824976, 0.0000000565688198108253, 0, 0, 0.00685633031420655,
	0.000267122243899158, 0.00121386640545516, 0.00189316384850391, 0.0185432319105211, 0.000322604150785616, 0.000997734501312261, 0.000151115807753049,
	0.00727618866382846, 0.00000553187022681816, 0.00097034347232829, 0.00086264683958804, 0.00175132924504412, 0.00160361051080336, 0.00726724440762037,
	0.00041619943700408, 0.00000998437559479706, 0.00120743054807433, 0.00396527277443648, 0.00361676412522561, 0.0012832875689174, 0.000692833068035106,
	0.000127573620476814, 0.0000117001977508271, 0.00247740121567257, 0.00000638130475950669, 0.00218017445738636, 0.0000791627681886449,
	0.00154749379397978, 0.0000525861528837849, 0.00932114579256985, 0.000171644609941975, 0.0000246797892394425, 0.00315240003593513,
	0.00550057242402309, 0.00000270310579335243, 0.000394646924127768, 0.000558806799872233, 0.000651990242526586, 0.0000917495595246322,
	0.00397732158372364, 0.00191254221137925, 0.0000744394655519391, 0.000059899480063942, 0.00405075208857857, 0.0105347565830679, 0.00311176534346594,
	0.0000124146065660765, 0.000235282013133657, 0.000000178663913317696, 0.000568447139655051, 0.00000249712549366259, 0.00529886070664851,
	0.0000254449452565147, 0.000261362824481929, 0.0000129588223388975, 0.0120486963406792, 0.0000566119465980448, 0.0000196913176664783,
	0.0355620338677883, 0.0134257881700898, 0.00000112412659329764, 0.00000463955858215001, 0.000984491816312819, 0.000264790885741504,
	0.000100106517504217, 0.0104126653027828, 0.0000429446345912766, 0.000000892801774187465, 0.00425820178202658, 0.00337488212622354,
	0.00170683302708128, 0.00254906719467637, 0.0000116346360118981, 0.000823722323209795, 0.00000118060143024116, 0.00227277100930774,
	0.0000384895448717729, 0.00136333252981045, 0.000885803335362938, 0.00187652262173153, 0.000914014863505342, 0.00147480347229814,
	0.000185322815095042, 0.00127907575650981, 0.0000106740257762745, 0.00101153312653588, 0.00000515949060066808, 0.0000460409299455149,
	0.00345829493834089, 0.00138382615616273, 0.0039441304637933, 0.000106567401281322, 0.00136012482893856, 0.00000256616743590059, 0.00542747781499987,
	0.00454257059209061, 0.00405151268199343, 0.00000780479657597412, 0.0000291709878858704, 0.0000027749785704842, 0.0000393478836604972,
	0.00004567302106663, 0.0000191064697309232, 0.00139980074543398, 0.000000885217179469592, 0.00000233036548578328, 0.00000298983688193746,
	0.00825280565994542, 0.000000549823535454432, 0.00000104986594203161, 0.000000954397081463754, 0.00269544349359987, 0.000000256899507892339,
	0.000000119711120548227, 0.00000412142145907136, 0.00000112716419049949, 0.0000015313078978855, 0.000711071848568639, 0.00000195415064934239,
	0.0000000754898762399487, 0.00000876035159729357, 0.00000576779878781709, 0.00000219243658437525, 0.0000221249596838625, 0.000000930100914329305,
	0.000000263218703098692, 0.000000159541769017767, 0.0000489722417453922, 0.000000177747846350696, 0.00385337077048425, 0.0000106144296441794,
	0.00000674132156010406, 0.0000353827628028047, 0.00360899232621168, 0.0000160765855079429, 0.00000097592625112374, 0.00378793431390925,
	0.00374420703184801, 0.000000324215711895178, 0.0000106735218153143, 0.000152211751898986, 0.0000108992576683645, 0.000789875968914678,
	0.00221754314981514, 0.00000744150881694212, 0, 0.000307611602680953, 0.000350841119912874, 0.000065414324851032, 0.00000695177331636376,
	0.000000138003378397215, 0.0000026164897642326, 0.0000000534237629531569, 0.0000242472084443233, 0, 0.00029601048911654, 0.000000767724409242149,
	0.000264597695268772, 0.0000000596748649122529, 0.000217945603248813, 0.0000185746458651459, 0.000000192415912044912, 0.0000417137338851048,
	0.000394183166555671, 0.000000181253584627427, 0.0000000997477409228154, 0.00000593271495823552, 0.00000232978988505256, 0.000000572270899995396,
	0.0000269880432164408, 0.000668638321181966, 0.00000291720550347297, 0.000000321814715624721, 0.000000640055245073125, 0.000466605249430491,
	0.0000477107256768797, 0.0000195330852738609, 0.00000223165864944744, 0.000028041737630369, 0.0000257640153177617, 0.0000000484174906704723,
	0.000157658164391192, 0.0000429912117910095, 0.000135005671070782, 0.0000681802487928927, 0.000926685760641261, 0.00000753516930528205,
	0.0000259259584377023, 0.0000052073200777763, 0.000288197255006996, 0.000000199078410706183, 0.00000329563656232067, 0.000147564559425444,
	0.000236748821121688, 0.000132141796411352, 0.00149901610143103, 0.000249143242295781, 0.000000136499297867967, 0.0000779158645054109,
	0.000968322624343259, 0.000166839046052102, 0.0000132768479490343, 0.00000181431726492516, 0.0000337168916541177, 0.00000149350905261145,
	0.000000706828121707229, 0.0000181220080621863, 0.000249036616072928, 0.00000207762817762951, 0.000000745052549776636, 0.000000501838720625904,
	0.000497325633547006, 0.000000215766576069015, 0.00000167631849700822, 0.0000066613318551079, 0.00012117448344353, 0.000000109597854721291,
	0.00000032150545879343, 0.0000125748548025346, 0.00000167169205737039, 0.00000152519014520228, 0.0000718101848967921, 0.000000482981856268413,
	0.000000323810344282603, 0.00000188693410264413, 0.00000297762691153874, 0.0000023504047610072, 0.0000215248592155742, 0.00000163803448734747,
	0.00000222696340725769, 0.000000038381893703688, 0.0000235748709709609, 0.0000266033915557344}

// getNgramFreq gets the frequency of an n-gram from a slice of frequencies.
// If there are no occurances of that n-gram, returns `0, false`.
func getNgramFreq(ngram []rune, freqs []float64) (float64, bool) {
	var index int
	for _, char := range ngram {
		i := alphaIndex(char)
		if i == -1 {
			return 0, false
		}
		index = index*26 + int(i)
	}
	if index == -1 {
		return 0, false
	}
	return freqs[index], true
}

// GetNgramEntropy gets the entropy of a string according to English n-gram frequencies.
func GetNgramEntropy(str string, n int, freqs []float64) float64 {
	runes := []rune(str)
	ngrams := make([][]rune, len(runes)-n+1)
	for i := 0; i <= len(runes)-n; i++ {
		ngrams[i] = runes[i : i+n]
	}
	var sum float64
	var ignored int
	for _, ngram := range ngrams {
		freq, hasFreq := getNgramFreq(ngram, freqs)
		if hasFreq && freq != 0 {
			sum += math.Log(freq)
		} else {
			ignored++
		}
	}
	return -sum / math.Log(2) / float64(len(ngrams)-ignored)
}

// GetUnigramEntropy gets the entropy of a string according to English unigram frequencies.
func GetUnigramEntropy(text string) float64 {
	return GetNgramEntropy(text, 1, unigramFreqs)
}

// GetBigramEntropy gets the entropy of a string according to English bigram frequencies.
func GetBigramEntropy(text string) float64 {
	return GetNgramEntropy(text, 2, bigramFreqs)
}
